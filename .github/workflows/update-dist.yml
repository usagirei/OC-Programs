name: Update Dist

on:
    push:
        branches:
            - master
    workflow_dispatch:

jobs:
    get-matrix:
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.get-matrix.outputs.matrix }}
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/lua/install
              with:
                  packages: ("luafilesystem")
            - uses: ./.github/actions/lua/add-bin
              with:
                  src: "${{ github.workspace }}/misc"
                  scripts: ("get-matrix")
            - id: get-matrix
              run: |
                  get-matrix >> $GITHUB_OUTPUT

    prepare-setup:
        runs-on: ubuntu-latest
        needs: [get-matrix]
        outputs:
           checksum: ${{ steps.checksum.outputs.checksum }}
        steps:
            - uses: actions/checkout@v3

            - uses: actions/cache@v3
              id: cache
              with:
                  path: |
                      misc/setup/setup.lua
                      misc/setup/.install
                  key: setup-${{ hashFiles('misc/setup/setup.lua', 'misc/setup/.install') }}

            - uses: ./.github/actions/lua/install
              if: steps.cache.outputs.cache-hit != 'true'
              with:
                  packages: ("luafilesystem")

            - uses: ./.github/actions/lua/add-path
              if: steps.cache.outputs.cache-hit != 'true'
              with:
                  path: "${{ github.workspace }}/libpack/data/lib/?.lua;${{ github.workspace }}/libpack/data/lib/?/init.lua"

            - uses: ./.github/actions/lua/add-bin
              if: steps.cache.outputs.cache-hit != 'true'
              with:
                  src: "${{ github.workspace }}/libpack/data/bin"
                  scripts: ("luapack" "luamin")

            - name: Pack Setup
              if: steps.cache.outputs.cache-hit != 'true'
              run: |
                  (cd 'misc/setup'; luapack)

            - name: Bundle Files
              run: |
                  tar -cvf setup.tar -C misc/setup .install setup.lua

            - id: checksum
              run: |
                  checksum=($(md5sum setup.tar))
                  echo "checksum=$checksum" >> $GITHUB_OUTPUT

            - uses: actions/upload-artifact@v3
              with:
                  name: setup-files
                  path: setup.tar
                  retention-days: 1

    create-tarballs:
        runs-on: ubuntu-latest
        needs: [get-matrix, prepare-setup]
        strategy:
            matrix: ${{ fromJSON(needs.get-matrix.outputs.matrix) }}
        steps:
            - run: echo Bundling ${{ matrix.program }}

            - uses: actions/checkout@v3
              with:
                  sparse-checkout: |
                      .github
                      libpack
                      dist/.${{ matrix.program }}.sum
                      ${{ matrix.program }}

            - id: checksum
              run: |
                datChecksum=($(find ${{ matrix.program }} -type f -exec md5sum {} \; | md5sum))
                if [[ $isSetup == "true" ]]; then newChecksum=($(echo "$datChecksum-$setChecksum" | md5sum)); else newChecksum="$datChecksum"; fi
                oldChecksum=$([[ -e $sumFile ]] && cat $sumFile  || echo '0')
                if [[ "$newChecksum" == "$oldChecksum" ]]; then echo "rebuild=false" >> $GITHUB_OUTPUT; else echo "rebuild=true" >> $GITHUB_OUTPUT; fi
                echo "checksum=$newChecksum" >> $GITHUB_OUTPUT
                echo "Set: $setChecksum"
                echo "Dat: $datChecksum"
                echo "New: $newChecksum"
                echo "Old: $oldChecksum"
              env:
                sumFile: "dist/.${{ matrix.program }}.sum"
                isSetup: "${{ matrix.setup }}"
                setChecksum: "${{ needs.prepare-setup.outputs.checksum }}"

            - run: echo "Unchanged - Skipping"
              if: steps.checksum.outputs.rebuild == 'false'
              
            - uses: ./.github/actions/lua/install
              if: steps.checksum.outputs.rebuild == 'true' && matrix.minified == true
              with:
                  packages: ("luafilesystem")

            - uses: ./.github/actions/lua/add-bin
              if: steps.checksum.outputs.rebuild == 'true' && matrix.minified == true
              with:
                  src: "${{ github.workspace }}/libpack/data/bin"
                  scripts: ("luamin")

            - uses: ./.github/actions/lua/add-path
              if: steps.checksum.outputs.rebuild == 'true' && matrix.minified == true
              with:
                  path: "${{ github.workspace }}/libpack/data/lib/?.lua;${{ github.workspace }}/libpack/data/lib/?/init.lua"

            - name: Minify
              if: steps.checksum.outputs.rebuild == 'true' && matrix.minified
              run: |
                  echo Minifying
                  (pushd ${{ matrix.program }} && \
                      find . -type f -name "*.lua" -printf '%P\0' | \
                      xargs -0 -i sh -c 'echo -n "$1..."; luamin "$1" "$1" || exit 255' sh {} \
                  )

            - name: Download Setup Files
              uses: actions/download-artifact@v3
              if: steps.checksum.outputs.rebuild == 'true' && matrix.setup == true
              with:
                  name: setup-files

            - name: Extract Setup Files
              if: steps.checksum.outputs.rebuild == 'true' && matrix.setup == true
              run: |
                  echo Extracting Setup files
                  tar -xvf setup.tar -C ${{ matrix.program }}

            - name: Create Tarball
              if: steps.checksum.outputs.rebuild == 'true'
              id: tarball
              run: |
                  mkdir -p dist
                  tar \
                      --sort=name --owner=root:0 --group=root:0 --mtime='1970-01-01 00:00:00' \
                      --exclude=.min --exclude=.dist \
                      -cvf $TARFILE \
                      -C $INPUT_ROOT .
                  echo "path=$TARFILE" >> $GITHUB_OUTPUT
              env:
                  TARFILE: "${{ runner.temp }}/${{ matrix.program }}${{ matrix.minified && '.min.tar' || '.tar' }}"
                  INPUT_ROOT: "${{ github.workspace }}/${{ matrix.program }}"

            - name: Update Checksum
              if: steps.checksum.outputs.rebuild == 'true'
              id: checksum-file
              run: |
                  echo "${{ steps.checksum.outputs.checksum }}" >> $sumFile
                  echo "path=$sumFile" >> $GITHUB_OUTPUT
              env:
                  sumFile: "${{ runner.temp }}/.${{ matrix.program }}.sum"

            - name: Upload Tarball
              uses: actions/upload-artifact@v3
              if: steps.checksum.outputs.rebuild == 'true'
              with:
                  name: tarballs
                  path: |
                      ${{ steps.tarball.outputs.path }}
                  retention-days: 1

            - name: Upload Checkfile
              uses: actions/upload-artifact@v3
              if: steps.checksum.outputs.rebuild == 'true' && matrix.writechk == true
              with:
                  name: tarballs
                  path: |
                      ${{ steps.checksum-file.outputs.path }}
                  retention-days: 1

    update-dist:
        runs-on: ubuntu-latest
        needs: [create-tarballs]
        permissions:
            contents: write
            pull-requests: write
        steps:
            - uses: actions/checkout@v3

            - name: Download Artifacts
              uses: actions/download-artifact@v3
              with:
                  name: tarballs
                  path: dist/

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v5
              with:
                  title: Update Dist Files
                  add-paths: dist
                  commit-message: "Update dist files"
                  reviewers: usagirei
                  branch: cpr/dist
                  delete-branch: true
